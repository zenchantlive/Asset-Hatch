{
  "reward": {
    "type": "xlm"
  },
  "sourcedFromGithub": false,
  "githubAsSourceMeta": null,
  "isAnonymous": false,
  "coverImage": "",
  "autoGeneratedCover": "",
  "hasPolls": false,
  "totalPollVotes": 0,
  "upvotes": 0,
  "downvotes": 0,
  "untaggedFrom": [],
  "upvotedBy": [],
  "downvotedBy": [],
  "responses": [],
  "followers": [],
  "answeredByTarget": false,
  "inviters": [],
  "duplicatePosts": [],
  "hasReward": false,
  "bookmarkedIn": [],
  "similarPostIds": [],
  "reactionsByCurrentUser": [],
  "toc": [],
  "_id": "695acc48f94021e4b87c76be",
  "createdAt": "2026-01-04T20:23:36.740Z",
  "updatedAt": "2026-01-04T21:28:11.223Z",
  "views": 3,
  "isActive": true,
  "hasLatex": false,
  "popularity": 7967.7115,
  "discussionScore": 0,
  "enableToc": false,
  "type": "story",
  "partOfPublication": true,
  "responseCount": 0,
  "replyCount": 0,
  "isFeatured": false,
  "isEngaging": false,
  "isDelisted": false,
  "isNotified": false,
  "numCollapsed": 0,
  "reactions": [],
  "totalReactions": 0,
  "totalReactionsByCurrentUser": 0,
  "isPinnedToBlog": false,
  "disableComments": false,
  "commentsPaused": false,
  "syncAlgolia": false,
  "numUniqueUsersWhoReacted": 0,
  "slugOverridden": true,
  "tweetOptions": {
    "enabled": false
  },
  "title": "Part 4: The Pivot - 3 Hours to Salvation",
  "cuid": "cmk06iwpu000902l56udp19ys",
  "dateAdded": "2026-01-04T20:23:36.738Z",
  "isCoverAttributionHidden": false,
  "stickCoverToBottom": false,
  "slug": "part-4-the-pivot-3-hours-to-salvation",
  "content": "<p><strong>Previously:</strong> CopilotKit v1.50.1 is broken. Tool execution doesn't work. Spent 4 hours debugging. Made the decision to migrate to Vercel AI SDK.</p>\n<p><strong>Now:</strong> 2:15 PM. Coffee refilled. Let's rip this out and rebuild it properly.</p>\n<h2 id=\"heading-the-migration-checklist\">The Migration Checklist</h2>\n<p>Before deleting a single line, I instructed Claude to write out the full migration plan:</p>\n<pre><code class=\"lang-markdown\"><span class=\"hljs-section\">## Vercel AI SDK Migration Plan</span>\n\n<span class=\"hljs-section\">### Phase 1: Research (30 min)</span>\n<span class=\"hljs-bullet\">-</span> [ ] Read ai.sdk.dev docs (streamText, tools, message handling)\n<span class=\"hljs-bullet\">-</span> [ ] Find OpenRouter integration example\n<span class=\"hljs-bullet\">-</span> [ ] Understand message format differences\n<span class=\"hljs-bullet\">-</span> [ ] Check Next.js 16 compatibility\n\n<span class=\"hljs-section\">### Phase 2: Dependencies (15 min)</span>\n<span class=\"hljs-bullet\">-</span> [ ] Remove: @copilotkit/react-core, @copilotkit/react-ui, @copilotkit/runtime\n<span class=\"hljs-bullet\">-</span> [ ] Install: ai, @ai-sdk/react, @openrouter/ai-sdk-provider\n<span class=\"hljs-bullet\">-</span> [ ] Update: package.json, remove from layout provider\n\n<span class=\"hljs-section\">### Phase 3: API Route (45 min)</span>\n<span class=\"hljs-bullet\">-</span> [ ] Create /app/api/chat/route.ts\n<span class=\"hljs-bullet\">-</span> [ ] Implement streamText with OpenRouter\n<span class=\"hljs-bullet\">-</span> [ ] Convert 3 tools to Zod schemas\n<span class=\"hljs-bullet\">-</span> [ ] Test with curl\n\n<span class=\"hljs-section\">### Phase 4: Client Hooks (45 min)</span>\n<span class=\"hljs-bullet\">-</span> [ ] Replace useCopilotChat with useChat\n<span class=\"hljs-bullet\">-</span> [ ] Update ChatInterface component\n<span class=\"hljs-bullet\">-</span> [ ] Handle message rendering (parts array)\n<span class=\"hljs-bullet\">-</span> [ ] Implement tool call callbacks\n\n<span class=\"hljs-section\">### Phase 5: Testing (30 min)</span>\n<span class=\"hljs-bullet\">-</span> [ ] Send test messages\n<span class=\"hljs-bullet\">-</span> [ ] Verify tool execution\n<span class=\"hljs-bullet\">-</span> [ ] Check database updates\n<span class=\"hljs-bullet\">-</span> [ ] Test conversation persistence\n\nTotal estimate: 3 hours 15 min\n</code></pre>\n<p><strong>Time tracking is critical for solo devs.</strong> If this goes over 4 hours, something's wrong and I need to reassess.</p>\n<h2 id=\"heading-phase-1-research-215-pm-252-pm\">Phase 1: Research (2:15 PM - 2:52 PM)</h2>\n<h3 id=\"heading-the-vercel-ai-sdk-architecture\">The Vercel AI SDK Architecture</h3>\n<p>Vercel AI SDK v6 has three main pieces:</p>\n<p><strong>1. Core (<code>ai</code> package)</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">import</span> { streamText, tool } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'ai'</span>;\n</code></pre>\n<ul>\n<li><code>streamText()</code> - Server-side text generation with streaming</li>\n<li><code>tool()</code> - Define tools with Zod schemas and execute functions</li>\n<li><code>convertToModelMessages()</code> - Convert UI messages to model format</li>\n</ul>\n<p><strong>2. React Hooks (<code>@ai-sdk/react</code> package)</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">import</span> { useChat } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@ai-sdk/react'</span>;\n</code></pre>\n<ul>\n<li><code>useChat()</code> - Client-side chat state management</li>\n<li>Handles: messages, input, submission, streaming, tool calls</li>\n</ul>\n<p><strong>3. Provider Adapters (e.g., <code>@openrouter/ai-sdk-provider</code>)</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">import</span> { openrouter } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@openrouter/ai-sdk-provider'</span>;\n</code></pre>\n<ul>\n<li>Official OpenRouter integration</li>\n<li>Handles API authentication, model selection, error handling</li>\n</ul>\n<h3 id=\"heading-key-difference-from-copilotkit\">Key Difference from CopilotKit</h3>\n<p><strong>CopilotKit:</strong></p>\n<ul>\n<li>Tools defined on client with <code>useCopilotAction</code></li>\n<li>\"Magic\" registration via React hooks</li>\n<li>Server runtime handles execution mysteriously</li>\n</ul>\n<p><strong>Vercel AI SDK:</strong></p>\n<ul>\n<li>Tools defined in API route with explicit Zod schemas</li>\n<li>Execution happens server-side in <code>tool.execute()</code></li>\n<li>Client receives tool call via streaming response</li>\n<li>Clear, explicit data flow</li>\n</ul>\n<p><strong>Translation:</strong> More boilerplate, but I can actually see what's happening.</p>\n<h3 id=\"heading-critical-discovery-ai-sdk-v6-changes\">Critical Discovery: AI SDK v6 Changes</h3>\n<p>The docs showed AI SDK v4 patterns. But I'm using v6 (released Nov 2025). Key changes:</p>\n<p><strong>Message structure:</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-comment\">// v4: Simple content string</span>\n{role: <span class=\"hljs-string\">'user'</span>, content: <span class=\"hljs-string\">'Hello'</span>}\n\n<span class=\"hljs-comment\">// v6: Parts array</span>\n{\n  role: <span class=\"hljs-string\">'user'</span>,\n  content: [{ <span class=\"hljs-keyword\">type</span>: <span class=\"hljs-string\">'text'</span>, text: <span class=\"hljs-string\">'Hello'</span> }]\n}\n</code></pre>\n<p><strong>Tool definition:</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-comment\">// v4: parameters property</span>\ntool({\n  parameters: z.object({...}),\n  execute: <span class=\"hljs-keyword\">async</span> ({...}) =&gt; {...}\n})\n\n<span class=\"hljs-comment\">// v6: inputSchema property</span>\ntool({\n  inputSchema: z.object({...}),\n  execute: <span class=\"hljs-keyword\">async</span> ({...}) =&gt; {...}\n})\n</code></pre>\n<p><strong>This is crucial.</strong> Using v4 patterns with v6 would cause subtle bugs. I bookmarked the v6 migration guide.</p>\n<p><strong>Time spent:</strong> 37 minutes (under budget ‚úÖ)</p>\n<h2 id=\"heading-phase-2-dependencies-252-pm-309-pm\">Phase 2: Dependencies (2:52 PM - 3:09 PM)</h2>\n<pre><code class=\"lang-bash\"><span class=\"hljs-comment\"># Remove CopilotKit</span>\nbun remove @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime\n\n<span class=\"hljs-comment\"># Install Vercel AI SDK v6</span>\nbun add ai@^6.0.3 @ai-sdk/react@^3.0.3 @openrouter/ai-sdk-provider@^1.5.4\n\n<span class=\"hljs-comment\"># Add Zod (for tool schemas)</span>\nbun add zod@^4.2.1\n</code></pre>\n<p><strong>Remove CopilotKit provider from layout:</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-comment\">// app/layout.tsx</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">RootLayout</span>(<span class=\"hljs-params\">{ children }</span>) </span>{\n  <span class=\"hljs-keyword\">return</span> (\n    &lt;html lang=<span class=\"hljs-string\">\"en\"</span>&gt;\n      &lt;body&gt;\n        {<span class=\"hljs-comment\">/* &lt;CopilotKit runtimeUrl=\"/api/copilotkit\"&gt; */</span>}\n        {children}\n        {<span class=\"hljs-comment\">/* &lt;/CopilotKit&gt; */</span>}\n      &lt;/body&gt;\n    &lt;/html&gt;\n  );\n}\n</code></pre>\n<p>No provider needed! Vercel AI SDK is provider-less. Each component connects directly to its API route.</p>\n<p><strong>Time spent:</strong> 17 minutes (under budget ‚úÖ)</p>\n<h2 id=\"heading-phase-3-api-route-309-pm-411-pm\">Phase 3: API Route (3:09 PM - 4:11 PM)</h2>\n<h3 id=\"heading-create-appapichatroutets\">Create /app/api/chat/route.ts</h3>\n<p>This is where the magic happens. The API route is the heart of the system.</p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">import</span> { openrouter } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@openrouter/ai-sdk-provider'</span>;\n<span class=\"hljs-keyword\">import</span> { streamText, tool, convertToModelMessages, stepCountIs } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'ai'</span>;\n<span class=\"hljs-keyword\">import</span> { NextRequest } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'next/server'</span>;\n<span class=\"hljs-keyword\">import</span> { z } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'zod'</span>;\n<span class=\"hljs-keyword\">import</span> { db } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@/lib/db'</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> maxDuration = <span class=\"hljs-number\">30</span>; <span class=\"hljs-comment\">// Vercel serverless function timeout</span>\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">POST</span>(<span class=\"hljs-params\">req: NextRequest</span>) </span>{\n  <span class=\"hljs-keyword\">try</span> {\n    <span class=\"hljs-comment\">// Parse request body</span>\n    <span class=\"hljs-keyword\">const</span> { messages, qualities, projectId } = <span class=\"hljs-keyword\">await</span> req.json();\n\n    <span class=\"hljs-comment\">// Convert UI messages to model format</span>\n    <span class=\"hljs-comment\">// CRITICAL: This is async in v6!</span>\n    <span class=\"hljs-keyword\">const</span> modelMessages = <span class=\"hljs-keyword\">await</span> convertToModelMessages(messages);\n\n    <span class=\"hljs-comment\">// Stream response with tools</span>\n    <span class=\"hljs-keyword\">const</span> result = streamText({\n      model: openrouter(<span class=\"hljs-string\">'google/gemini-3-pro-preview'</span>),\n      messages: modelMessages,\n      stopWhen: stepCountIs(<span class=\"hljs-number\">10</span>), <span class=\"hljs-comment\">// Prevent infinite tool loops</span>\n      system: <span class=\"hljs-string\">`You are a proactive Game Design Agent...\n               Current Project: <span class=\"hljs-subst\">${projectId}</span>\n               Current Qualities: <span class=\"hljs-subst\">${<span class=\"hljs-built_in\">JSON</span>.stringify(qualities, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-number\">2</span>)}</span>\n               ...`</span>, <span class=\"hljs-comment\">// Full system prompt</span>\n\n      tools: {\n        updateQuality: tool({\n          description: <span class=\"hljs-string\">'Update a specific quality parameter'</span>,\n          inputSchema: z.object({\n            qualityKey: z.enum([\n              <span class=\"hljs-string\">'art_style'</span>,\n              <span class=\"hljs-string\">'base_resolution'</span>,\n              <span class=\"hljs-string\">'perspective'</span>,\n              <span class=\"hljs-string\">'game_genre'</span>,\n              <span class=\"hljs-string\">'theme'</span>,\n              <span class=\"hljs-string\">'mood'</span>,\n              <span class=\"hljs-string\">'color_palette'</span>\n            ]),\n            value: z.string().min(<span class=\"hljs-number\">1</span>),\n          }),\n          execute: <span class=\"hljs-keyword\">async</span> ({ qualityKey, value }) =&gt; {\n            <span class=\"hljs-comment\">// This runs on the server!</span>\n            <span class=\"hljs-keyword\">await</span> db.projects.update(projectId, {\n              [qualityKey]: value,\n              updated_at: <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>().toISOString(),\n            });\n\n            <span class=\"hljs-keyword\">return</span> {\n              success: <span class=\"hljs-literal\">true</span>,\n              message: <span class=\"hljs-string\">`Updated <span class=\"hljs-subst\">${qualityKey}</span> to \"<span class=\"hljs-subst\">${value}</span>\"`</span>,\n              qualityKey,\n              value,\n            };\n          },\n        }),\n\n        updatePlan: tool({\n          description: <span class=\"hljs-string\">'Update the asset plan markdown'</span>,\n          inputSchema: z.object({\n            planMarkdown: z.string().min(<span class=\"hljs-number\">10</span>),\n          }),\n          execute: <span class=\"hljs-keyword\">async</span> ({ planMarkdown }) =&gt; {\n            <span class=\"hljs-keyword\">await</span> db.memoryFiles.upsert({\n              project_id: projectId,\n              file_name: <span class=\"hljs-string\">'entities.json'</span>,\n              content: planMarkdown,\n            });\n\n            <span class=\"hljs-keyword\">return</span> { success: <span class=\"hljs-literal\">true</span>, planMarkdown };\n          },\n        }),\n\n        finalizePlan: tool({\n          description: <span class=\"hljs-string\">'Mark planning phase complete'</span>,\n          inputSchema: z.object({}), <span class=\"hljs-comment\">// No parameters</span>\n          execute: <span class=\"hljs-keyword\">async</span> () =&gt; {\n            <span class=\"hljs-keyword\">await</span> db.projects.update(projectId, {\n              phase: <span class=\"hljs-string\">'style'</span>,\n              updated_at: <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>().toISOString(),\n            });\n\n            <span class=\"hljs-keyword\">return</span> { success: <span class=\"hljs-literal\">true</span>, nextPhase: <span class=\"hljs-string\">'style'</span> };\n          },\n        }),\n      },\n    });\n\n    <span class=\"hljs-comment\">// Return streaming response</span>\n    <span class=\"hljs-keyword\">return</span> result.toUIMessageStreamResponse();\n\n  } <span class=\"hljs-keyword\">catch</span> (error) {\n    <span class=\"hljs-built_in\">console</span>.error(<span class=\"hljs-string\">'[Chat API Error]'</span>, error);\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Response(<span class=\"hljs-string\">'Internal Server Error'</span>, { status: <span class=\"hljs-number\">500</span> });\n  }\n}\n</code></pre>\n<h3 id=\"heading-whats-happening-here\">What's Happening Here?</h3>\n<p><strong>1. Model Messages Conversion</strong></p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">const</span> modelMessages = <span class=\"hljs-keyword\">await</span> convertToModelMessages(messages);\n</code></pre>\n<p>Client sends messages in UI format (with parts arrays). This converts them to model-specific format. <strong>Critical:</strong> It's async! Forgetting <code>await</code> caused 20 minutes of debugging.</p>\n<p><strong>2. System Prompt with Context</strong></p>\n<pre><code class=\"lang-typescript\">system: <span class=\"hljs-string\">`You are a proactive Game Design Agent...\n         Current Qualities: <span class=\"hljs-subst\">${<span class=\"hljs-built_in\">JSON</span>.stringify(qualities, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-number\">2</span>)}</span>`</span>,\n</code></pre>\n<p>Every request includes current project state. The AI always knows what's been set so far.</p>\n<p><strong>3. Tool Schemas with Zod</strong></p>\n<pre><code class=\"lang-typescript\">inputSchema: z.object({\n  qualityKey: z.enum([<span class=\"hljs-string\">'art_style'</span>, <span class=\"hljs-string\">'base_resolution'</span>, ...]),\n  value: z.string().min(<span class=\"hljs-number\">1</span>),\n}),\n</code></pre>\n<p>Type-safe parameters. The SDK validates inputs before execution. Invalid data = error, not silent failure.</p>\n<p><strong>4. Server-Side Execution</strong></p>\n<pre><code class=\"lang-typescript\">execute: <span class=\"hljs-keyword\">async</span> ({ qualityKey, value }) =&gt; {\n  <span class=\"hljs-keyword\">await</span> db.projects.update(projectId, { ... });\n  <span class=\"hljs-keyword\">return</span> { success: <span class=\"hljs-literal\">true</span>, ... };\n},\n</code></pre>\n<p>Tools execute on the server. Full database access. No client-side security concerns.</p>\n<p><strong>5. stopWhen: stepCountIs(10)</strong></p>\n<p>Prevents infinite loops. If the AI calls tools 10 times in one turn, stop. This saved me from a runaway generation bill later.</p>\n<h3 id=\"heading-first-test-curl\">First Test (curl)</h3>\n<pre><code class=\"lang-bash\">curl -X POST http://localhost:3000/api/chat \\\n  -H <span class=\"hljs-string\">\"Content-Type: application/json\"</span> \\\n  -d <span class=\"hljs-string\">'{\n    \"messages\": [{\"role\": \"user\", \"content\": \"Set art style to pixel art\"}],\n    \"qualities\": {},\n    \"projectId\": \"test-123\"\n  }'</span>\n</code></pre>\n<p><strong>Response:</strong></p>\n<pre><code>data: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"text\"</span>,<span class=\"hljs-string\">\"content\"</span>:<span class=\"hljs-string\">\"I'll \"</span>}\n<span class=\"hljs-attr\">data</span>: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"text\"</span>,<span class=\"hljs-string\">\"content\"</span>:<span class=\"hljs-string\">\"update \"</span>}\n<span class=\"hljs-attr\">data</span>: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"text\"</span>,<span class=\"hljs-string\">\"content\"</span>:<span class=\"hljs-string\">\"the art style\"</span>}\n<span class=\"hljs-attr\">data</span>: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"tool-call\"</span>,<span class=\"hljs-string\">\"toolName\"</span>:<span class=\"hljs-string\">\"updateQuality\"</span>,<span class=\"hljs-string\">\"args\"</span>:{<span class=\"hljs-string\">\"qualityKey\"</span>:<span class=\"hljs-string\">\"art_style\"</span>,<span class=\"hljs-string\">\"value\"</span>:<span class=\"hljs-string\">\"Pixel Art\"</span>}}\n<span class=\"hljs-attr\">data</span>: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"tool-result\"</span>,<span class=\"hljs-string\">\"toolName\"</span>:<span class=\"hljs-string\">\"updateQuality\"</span>,<span class=\"hljs-string\">\"result\"</span>:{<span class=\"hljs-string\">\"success\"</span>:<span class=\"hljs-literal\">true</span>}}\n<span class=\"hljs-attr\">data</span>: {<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-string\">\"text\"</span>,<span class=\"hljs-string\">\"content\"</span>:<span class=\"hljs-string\">\" to Pixel Art.\"</span>}\n</code></pre><p><strong>IT WORKED.</strong></p>\n<p>Tool execution visible in the stream. Database updated. Success returned.</p>\n<p><strong>Time spent:</strong> 62 minutes (over budget by 17 min, but working ‚úÖ)</p>\n<h2 id=\"heading-phase-4-client-hooks-411-pm-502-pm\">Phase 4: Client Hooks (4:11 PM - 5:02 PM)</h2>\n<h3 id=\"heading-replace-usecopilotchat-with-usechat\">Replace useCopilotChat with useChat</h3>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-comment\">// components/planning/ChatInterface.tsx</span>\n<span class=\"hljs-string\">'use client'</span>;\n\n<span class=\"hljs-keyword\">import</span> { useChat } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@ai-sdk/react'</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">ChatInterface</span>(<span class=\"hljs-params\">{ projectId, qualities }: Props</span>) </span>{\n  <span class=\"hljs-keyword\">const</span> {\n    messages,\n    input,\n    handleInputChange,\n    handleSubmit,\n    isLoading,\n  } = useChat({\n    api: <span class=\"hljs-string\">'/api/chat'</span>,\n    body: { <span class=\"hljs-comment\">// Send additional context</span>\n      projectId,\n      qualities,\n    },\n    onToolCall: <span class=\"hljs-keyword\">async</span> ({ toolCall }) =&gt; {\n      <span class=\"hljs-comment\">// Handle tool execution on client</span>\n      <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">'üîß Tool called:'</span>, toolCall);\n\n      <span class=\"hljs-keyword\">if</span> (toolCall.toolName === <span class=\"hljs-string\">'updateQuality'</span>) {\n        <span class=\"hljs-keyword\">const</span> { qualityKey, value } = toolCall.input;\n        <span class=\"hljs-comment\">// Update local state to reflect change immediately</span>\n        onQualityUpdate?.(qualityKey, value);\n      }\n\n      <span class=\"hljs-keyword\">if</span> (toolCall.toolName === <span class=\"hljs-string\">'updatePlan'</span>) {\n        <span class=\"hljs-keyword\">const</span> { planMarkdown } = toolCall.input;\n        onPlanUpdate?.(planMarkdown);\n      }\n\n      <span class=\"hljs-keyword\">if</span> (toolCall.toolName === <span class=\"hljs-string\">'finalizePlan'</span>) {\n        <span class=\"hljs-comment\">// Navigate to next phase</span>\n        router.push(<span class=\"hljs-string\">`/project/<span class=\"hljs-subst\">${projectId}</span>/style`</span>);\n      }\n    },\n  });\n\n  <span class=\"hljs-keyword\">return</span> (\n    &lt;div className=<span class=\"hljs-string\">\"chat-container\"</span>&gt;\n      &lt;div className=<span class=\"hljs-string\">\"messages\"</span>&gt;\n        {messages.map(<span class=\"hljs-function\"><span class=\"hljs-params\">msg</span> =&gt;</span> (\n          &lt;Message key={msg.id} message={msg} /&gt;\n        ))}\n      &lt;/div&gt;\n\n      &lt;form onSubmit={handleSubmit}&gt;\n        &lt;input\n          value={input}\n          onChange={handleInputChange}\n          placeholder=<span class=\"hljs-string\">\"Describe your game...\"</span>\n        /&gt;\n        &lt;button <span class=\"hljs-keyword\">type</span>=<span class=\"hljs-string\">\"submit\"</span> disabled={isLoading}&gt;\n          {isLoading ? <span class=\"hljs-string\">'Thinking...'</span> : <span class=\"hljs-string\">'Send'</span>}\n        &lt;/button&gt;\n      &lt;/form&gt;\n    &lt;/div&gt;\n  );\n}\n</code></pre>\n<h3 id=\"heading-rendering-messages-with-parts\">Rendering Messages with Parts</h3>\n<p>AI SDK v6 messages have a <code>parts</code> array:</p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">Message</span>(<span class=\"hljs-params\">{ message }</span>) </span>{\n  <span class=\"hljs-comment\">// Extract text from all parts</span>\n  <span class=\"hljs-keyword\">const</span> text = message.parts\n    ?.map(<span class=\"hljs-function\"><span class=\"hljs-params\">part</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">if</span> (part.type === <span class=\"hljs-string\">'text'</span>) <span class=\"hljs-keyword\">return</span> part.text;\n      <span class=\"hljs-keyword\">if</span> (part.type === <span class=\"hljs-string\">'reasoning'</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">`[Thinking: <span class=\"hljs-subst\">${part.text}</span>]`</span>;\n      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">''</span>;\n    })\n    .join(<span class=\"hljs-string\">''</span>) || <span class=\"hljs-string\">''</span>;\n\n  <span class=\"hljs-keyword\">return</span> (\n    &lt;div className={<span class=\"hljs-string\">`message <span class=\"hljs-subst\">${message.role}</span>`</span>}&gt;\n      {text}\n    &lt;/div&gt;\n  );\n}\n</code></pre>\n<p><strong>Why parts?</strong> Future-proofing. v6 supports images, files, tool calls, reasoning‚Äîall as different part types.</p>\n<p><strong>Time spent:</strong> 51 minutes (over budget by 6 min, but working ‚úÖ)</p>\n<h2 id=\"heading-phase-5-testing-502-pm-531-pm\">Phase 5: Testing (5:02 PM - 5:31 PM)</h2>\n<h3 id=\"heading-test-1-simple-message\">Test 1: Simple Message</h3>\n<pre><code>Me: <span class=\"hljs-string\">\"Hello\"</span>\n\n<span class=\"hljs-attr\">AI</span>: <span class=\"hljs-string\">\"Hi! I'm here to help you plan game assets. What kind of\n     game are you building?\"</span>\n</code></pre><p>‚úÖ <strong>Chat works.</strong></p>\n<h3 id=\"heading-test-2-tool-execution\">Test 2: Tool Execution</h3>\n<pre><code>Me: <span class=\"hljs-string\">\"Let's make a pixel art platformer\"</span>\n\n<span class=\"hljs-attr\">AI</span>: [Thinking...]\n    <span class=\"hljs-string\">\"Great! I'll set up your project with:\n     - Art Style: Pixel Art\n     - Genre: Platformer\n\n     What perspective would you like? Side-view is common for\n     platformers.\"</span>\n\n[Check <span class=\"hljs-built_in\">console</span>]\nüîß Tool called: {<span class=\"hljs-attr\">toolName</span>: <span class=\"hljs-string\">\"updateQuality\"</span>, <span class=\"hljs-attr\">input</span>: {<span class=\"hljs-attr\">qualityKey</span>: <span class=\"hljs-string\">\"art_style\"</span>, <span class=\"hljs-attr\">value</span>: <span class=\"hljs-string\">\"Pixel Art\"</span>}}\nüîß Tool called: {<span class=\"hljs-attr\">toolName</span>: <span class=\"hljs-string\">\"updateQuality\"</span>, <span class=\"hljs-attr\">input</span>: {<span class=\"hljs-attr\">qualityKey</span>: <span class=\"hljs-string\">\"game_genre\"</span>, <span class=\"hljs-attr\">value</span>: <span class=\"hljs-string\">\"Platformer\"</span>}}\n\n[Check database]\nSELECT art_style, game_genre FROM projects WHERE id = <span class=\"hljs-string\">'...'</span>;\n-- art_style: <span class=\"hljs-string\">\"Pixel Art\"</span>\n-- game_genre: <span class=\"hljs-string\">\"Platformer\"</span>\n</code></pre><p>‚úÖ <strong>Tools execute and database updates.</strong></p>\n<h3 id=\"heading-test-3-plan-building\">Test 3: Plan Building</h3>\n<pre><code>Me: <span class=\"hljs-string\">\"Show me a plan\"</span>\n\n<span class=\"hljs-attr\">AI</span>: [Thinking...]\n    <span class=\"hljs-string\">\"Here's a starting asset plan for your pixel art platformer...\"</span>\n\n    [Calls updatePlan tool <span class=\"hljs-keyword\">with</span> full markdown]\n\n[Right panel updates <span class=\"hljs-keyword\">with</span> formatted plan]\n</code></pre><p>‚úÖ <strong>Plan preview works.</strong></p>\n<h3 id=\"heading-test-4-finalization\">Test 4: Finalization</h3>\n<pre><code>Me: <span class=\"hljs-string\">\"This looks perfect, let's use it\"</span>\n\n<span class=\"hljs-attr\">AI</span>: <span class=\"hljs-string\">\"Excellent! I'll finalize your plan.\"</span>\n    [Calls finalizePlan tool]\n    <span class=\"hljs-string\">\"Your plan is saved. Moving to style anchoring...\"</span>\n\n[Navigation triggers to /project/[id]/style]\n</code></pre><p>‚úÖ <strong>Phase transition works.</strong></p>\n<h3 id=\"heading-the-moment\">The Moment</h3>\n<p>5:28 PM. All tests pass. Tools execute reliably. Database updates correctly. UI reflects changes.</p>\n<p><strong>Asset Hatch has a working AI planning agent.</strong></p>\n<p>After 4 hours of CopilotKit debugging hell, 3 hours of migration, and 1 crisis of confidence‚Äî<strong>it finally works.</strong></p>\n<p>I took a screenshot. Committed the code. Went outside for 10 minutes.</p>\n<p><strong>Time spent:</strong> 29 minutes (under budget ‚úÖ)</p>\n<h2 id=\"heading-what-i-learned-the-hard-way\">What I Learned (The Hard Way)</h2>\n<h3 id=\"heading-1-ai-sdk-v6-is-different\">1. AI SDK v6 is Different</h3>\n<p>Don't copy v4 examples. <code>inputSchema</code> not <code>parameters</code>. <code>await convertToModelMessages()</code> is critical.</p>\n<h3 id=\"heading-2-system-prompts-matter\">2. System Prompts Matter</h3>\n<p>The AI is only as agentic as you make it. Compare:</p>\n<p><strong>Weak:</strong></p>\n<pre><code class=\"lang-typescript\">system: <span class=\"hljs-string\">\"You are a helpful assistant.\"</span>\n</code></pre>\n<p><strong>Strong:</strong></p>\n<pre><code class=\"lang-typescript\">system: <span class=\"hljs-string\">`You are a PROACTIVE Game Design Agent.\n\nDO NOT wait for permission. When the user implies a preference,\nSET IT IMMEDIATELY using tools.\n\nExample:\nUser: \"I want pixel art\"\nYou: [Call updateQuality IMMEDIATELY] then respond\nNOT: \"Great choice! Would you like me to set that?\"\n`</span>\n</code></pre>\n<p>The second version produced 10x better results.</p>\n<h3 id=\"heading-3-stopwhen-is-essential\">3. stopWhen is Essential</h3>\n<pre><code class=\"lang-typescript\">stopWhen: stepCountIs(<span class=\"hljs-number\">10</span>)\n</code></pre>\n<p>Without this, I had cases where the AI got stuck in a loop:</p>\n<pre><code>Call updateQuality ‚Üí Call updateQuality ‚Üí Call updateQuality...\n</code></pre><p>10 steps is generous but prevents runaway costs.</p>\n<h3 id=\"heading-4-server-side-tools-are-better\">4. Server-Side Tools are Better</h3>\n<p>With CopilotKit, tools were client-side React hooks. With Vercel AI SDK, they're server-side functions.</p>\n<p><strong>Benefits:</strong></p>\n<ul>\n<li>Full database access (no API roundtrip needed)</li>\n<li>Security (client can't bypass validation)</li>\n<li>Simpler state management (single source of truth)</li>\n</ul>\n<h3 id=\"heading-5-type-safety-catches-bugs-early\">5. Type Safety Catches Bugs Early</h3>\n<p>Zod schemas caught multiple bugs before they hit production:</p>\n<pre><code class=\"lang-typescript\">qualityKey: z.enum([<span class=\"hljs-string\">'art_style'</span>, <span class=\"hljs-string\">'base_resolution'</span>, ...])\n</code></pre>\n<p>If the AI calls <code>updateQuality({qualityKey: 'invalid', ...})</code>, it fails immediately with a clear error.</p>\n<h3 id=\"heading-6-migration-took-exactly-as-long-as-estimated\">6. Migration Took Exactly as Long as Estimated</h3>\n<p><strong>Estimate:</strong> 3h 15min\n<strong>Actual:</strong> 3h 16min</p>\n<p>Why? Because I broke it into phases and tracked time actively. When Phase 3 went over by 17 minutes, I compressed Phase 4.</p>\n<h2 id=\"heading-the-commits\">The Commits</h2>\n<pre><code class=\"lang-bash\">commit 5c5c305\nDate: Dec 26, 2025 - 3:12 PM\nMessage: feat: Set up initial Next.js application with CopilotKit\n         integration (before migration)\n\ncommit 6fbfd99\nDate: Dec 26, 2025 - 5:31 PM\nMessage: feat: Complete AI SDK v6 migration with working tool execution\n\nFiles changed: 11\nInsertions: 182\nDeletions: 104\n</code></pre>\n<h2 id=\"heading-adr-005httpsgithubcomzenchantliveasset-hatchblobmainsrcmemoryadr005-replace-copilotkit-with-vercel-ai-sdkmd-replace-copilotkit-with-vercel-ai-sdk\"><a target=\"_blank\" href=\"https://github.com/zenchantlive/Asset-Hatch/blob/main/src/memory/adr/005-replace-copilotkit-with-vercel-ai-sdk.md\">ADR-005</a>: Replace CopilotKit with Vercel AI SDK</h2>\n<p><strong>Status:</strong> Accepted\n<strong>Date:</strong> 2025-12-26\n<strong>Supersedes:</strong> ADR-001</p>\n<p><strong>Decision:</strong> Replace CopilotKit v1.50.1 with Vercel AI SDK v6 due to blocking bug in tool execution.</p>\n<p><strong>Rationale:</strong></p>\n<ul>\n<li>CopilotKit <code>appendMessage</code> bug with no ETA for fix</li>\n<li>Vercel AI SDK has 200x larger user base</li>\n<li>Better type safety with Zod</li>\n<li>More control over tool execution flow</li>\n<li>Future-proof (Vercel team maintains it actively)</li>\n</ul>\n<p><strong>Trade-offs:</strong></p>\n<ul>\n<li>3 hours of migration work</li>\n<li>More boilerplate code</li>\n<li>Had to learn new API patterns</li>\n</ul>\n<p><strong>Result:</strong> ‚úÖ Complete success. Tool execution works reliably.</p>\n<hr />\n<h2 id=\"heading-reflections\">Reflections</h2>\n<p>This crisis forced me to learn AI SDK architecture at a depth I never would have otherwise.</p>\n<p>I now understand:</p>\n<ul>\n<li>How streaming responses actually work</li>\n<li>Why message conversion is necessary</li>\n<li>How tool calling flows from client ‚Üí server ‚Üí model ‚Üí back</li>\n<li>The difference between UI messages and model messages</li>\n<li>Why type safety in tool schemas matters</li>\n</ul>\n<p><strong>The best learning comes from fixing broken things.</strong></p>\n<p>If CopilotKit had worked, I'd have treated it as magic. Because it broke, I had to understand the actual mechanics.</p>\n<p>Sometimes the frameworks that fail you teach you the most.</p>\n<hr />\n<h2 id=\"heading-coming-next\">Coming Next</h2>\n<p>In <a target=\"_blank\" href=\"05-the-architecture-hybrid-persistence.md\">Part 5: The Architecture</a>, we hit another wall.</p>\n<p>Turns out, you can't use Dexie (IndexedDB) in Next.js API routes. API routes run in Node.js. IndexedDB is browser-only.</p>\n<p>When the <code>/api/generate</code> route tried to read style anchors from the database, it crashed hard.</p>\n<p>The solution? <strong>Hybrid persistence</strong> ‚Äî Prisma/SQLite for server, Dexie for client, sync between them.</p>\n<p>But figuring that out took another debugging marathon and an IndexedDB polyfill hack that I'm both proud of and ashamed of.</p>\n<hr />\n<p><strong>Commit References:</strong></p>\n<ul>\n<li><code>5c5c305</code> - Initial Next.js with CopilotKit (pre-migration)</li>\n<li><code>6fbfd99</code> - Complete AI SDK v6 migration with working tools</li>\n</ul>\n<p><strong>Files Created:</strong></p>\n<ul>\n<li><code>/app/api/chat/route.ts</code> - New Vercel AI SDK route</li>\n<li><code>/memory/AI_SDK_V6_GUIDE.md</code> - Internal reference docs</li>\n<li><code>/memory/adr/005-replace-copilotkit-with-vercel-ai-sdk.md</code> - Decision record</li>\n</ul>\n<p><strong>Tools Used:</strong></p>\n<ul>\n<li>Vercel AI SDK v6.0.3</li>\n<li>@openrouter/ai-sdk-provider v1.5.4</li>\n<li>Zod v4.2.1</li>\n</ul>\n<p><strong>Time Investment:</strong></p>\n<ul>\n<li>Research: 37 min</li>\n<li>Dependencies: 17 min</li>\n<li>API Route: 62 min</li>\n<li>Client Hooks: 51 min</li>\n<li>Testing: 29 min</li>\n<li><strong>Total:</strong> 3h 16min</li>\n</ul>\n<hr />\n<p><strong>Previous:</strong> <a target=\"_blank\" href=\"03-the-crisis-when-frameworks-fail.md\">‚Üê Part 3: The Crisis</a>\n<strong>Next:</strong> <a target=\"_blank\" href=\"05-the-architecture-hybrid-persistence.md\">Part 5: The Architecture ‚Üí</a></p>\n",
  "contentMarkdown": "**Previously:** CopilotKit v1.50.1 is broken. Tool execution doesn't work. Spent 4 hours debugging. Made the decision to migrate to Vercel AI SDK.\n\n**Now:** 2:15 PM. Coffee refilled. Let's rip this out and rebuild it properly.\n\n## The Migration Checklist\n\nBefore deleting a single line, I instructed Claude to write out the full migration plan:\n\n```markdown\n## Vercel AI SDK Migration Plan\n\n### Phase 1: Research (30 min)\n- [ ] Read ai.sdk.dev docs (streamText, tools, message handling)\n- [ ] Find OpenRouter integration example\n- [ ] Understand message format differences\n- [ ] Check Next.js 16 compatibility\n\n### Phase 2: Dependencies (15 min)\n- [ ] Remove: @copilotkit/react-core, @copilotkit/react-ui, @copilotkit/runtime\n- [ ] Install: ai, @ai-sdk/react, @openrouter/ai-sdk-provider\n- [ ] Update: package.json, remove from layout provider\n\n### Phase 3: API Route (45 min)\n- [ ] Create /app/api/chat/route.ts\n- [ ] Implement streamText with OpenRouter\n- [ ] Convert 3 tools to Zod schemas\n- [ ] Test with curl\n\n### Phase 4: Client Hooks (45 min)\n- [ ] Replace useCopilotChat with useChat\n- [ ] Update ChatInterface component\n- [ ] Handle message rendering (parts array)\n- [ ] Implement tool call callbacks\n\n### Phase 5: Testing (30 min)\n- [ ] Send test messages\n- [ ] Verify tool execution\n- [ ] Check database updates\n- [ ] Test conversation persistence\n\nTotal estimate: 3 hours 15 min\n```\n\n**Time tracking is critical for solo devs.** If this goes over 4 hours, something's wrong and I need to reassess.\n\n## Phase 1: Research (2:15 PM - 2:52 PM)\n\n### The Vercel AI SDK Architecture\n\nVercel AI SDK v6 has three main pieces:\n\n**1. Core (`ai` package)**\n```typescript\nimport { streamText, tool } from 'ai';\n```\n- `streamText()` - Server-side text generation with streaming\n- `tool()` - Define tools with Zod schemas and execute functions\n- `convertToModelMessages()` - Convert UI messages to model format\n\n**2. React Hooks (`@ai-sdk/react` package)**\n```typescript\nimport { useChat } from '@ai-sdk/react';\n```\n- `useChat()` - Client-side chat state management\n- Handles: messages, input, submission, streaming, tool calls\n\n**3. Provider Adapters (e.g., `@openrouter/ai-sdk-provider`)**\n```typescript\nimport { openrouter } from '@openrouter/ai-sdk-provider';\n```\n- Official OpenRouter integration\n- Handles API authentication, model selection, error handling\n\n### Key Difference from CopilotKit\n\n**CopilotKit:**\n- Tools defined on client with `useCopilotAction`\n- \"Magic\" registration via React hooks\n- Server runtime handles execution mysteriously\n\n**Vercel AI SDK:**\n- Tools defined in API route with explicit Zod schemas\n- Execution happens server-side in `tool.execute()`\n- Client receives tool call via streaming response\n- Clear, explicit data flow\n\n**Translation:** More boilerplate, but I can actually see what's happening.\n\n### Critical Discovery: AI SDK v6 Changes\n\nThe docs showed AI SDK v4 patterns. But I'm using v6 (released Nov 2025). Key changes:\n\n**Message structure:**\n```typescript\n// v4: Simple content string\n{role: 'user', content: 'Hello'}\n\n// v6: Parts array\n{\n  role: 'user',\n  content: [{ type: 'text', text: 'Hello' }]\n}\n```\n\n**Tool definition:**\n```typescript\n// v4: parameters property\ntool({\n  parameters: z.object({...}),\n  execute: async ({...}) => {...}\n})\n\n// v6: inputSchema property\ntool({\n  inputSchema: z.object({...}),\n  execute: async ({...}) => {...}\n})\n```\n\n**This is crucial.** Using v4 patterns with v6 would cause subtle bugs. I bookmarked the v6 migration guide.\n\n**Time spent:** 37 minutes (under budget ‚úÖ)\n\n## Phase 2: Dependencies (2:52 PM - 3:09 PM)\n\n```bash\n# Remove CopilotKit\nbun remove @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime\n\n# Install Vercel AI SDK v6\nbun add ai@^6.0.3 @ai-sdk/react@^3.0.3 @openrouter/ai-sdk-provider@^1.5.4\n\n# Add Zod (for tool schemas)\nbun add zod@^4.2.1\n```\n\n**Remove CopilotKit provider from layout:**\n\n```typescript\n// app/layout.tsx\nexport default function RootLayout({ children }) {\n  return (\n    <html lang=\"en\">\n      <body>\n        {/* <CopilotKit runtimeUrl=\"/api/copilotkit\"> */}\n        {children}\n        {/* </CopilotKit> */}\n      </body>\n    </html>\n  );\n}\n```\n\nNo provider needed! Vercel AI SDK is provider-less. Each component connects directly to its API route.\n\n**Time spent:** 17 minutes (under budget ‚úÖ)\n\n## Phase 3: API Route (3:09 PM - 4:11 PM)\n\n### Create /app/api/chat/route.ts\n\nThis is where the magic happens. The API route is the heart of the system.\n\n```typescript\nimport { openrouter } from '@openrouter/ai-sdk-provider';\nimport { streamText, tool, convertToModelMessages, stepCountIs } from 'ai';\nimport { NextRequest } from 'next/server';\nimport { z } from 'zod';\nimport { db } from '@/lib/db';\n\nexport const maxDuration = 30; // Vercel serverless function timeout\n\nexport async function POST(req: NextRequest) {\n  try {\n    // Parse request body\n    const { messages, qualities, projectId } = await req.json();\n\n    // Convert UI messages to model format\n    // CRITICAL: This is async in v6!\n    const modelMessages = await convertToModelMessages(messages);\n\n    // Stream response with tools\n    const result = streamText({\n      model: openrouter('google/gemini-3-pro-preview'),\n      messages: modelMessages,\n      stopWhen: stepCountIs(10), // Prevent infinite tool loops\n      system: `You are a proactive Game Design Agent...\n               Current Project: ${projectId}\n               Current Qualities: ${JSON.stringify(qualities, null, 2)}\n               ...`, // Full system prompt\n\n      tools: {\n        updateQuality: tool({\n          description: 'Update a specific quality parameter',\n          inputSchema: z.object({\n            qualityKey: z.enum([\n              'art_style',\n              'base_resolution',\n              'perspective',\n              'game_genre',\n              'theme',\n              'mood',\n              'color_palette'\n            ]),\n            value: z.string().min(1),\n          }),\n          execute: async ({ qualityKey, value }) => {\n            // This runs on the server!\n            await db.projects.update(projectId, {\n              [qualityKey]: value,\n              updated_at: new Date().toISOString(),\n            });\n\n            return {\n              success: true,\n              message: `Updated ${qualityKey} to \"${value}\"`,\n              qualityKey,\n              value,\n            };\n          },\n        }),\n\n        updatePlan: tool({\n          description: 'Update the asset plan markdown',\n          inputSchema: z.object({\n            planMarkdown: z.string().min(10),\n          }),\n          execute: async ({ planMarkdown }) => {\n            await db.memoryFiles.upsert({\n              project_id: projectId,\n              file_name: 'entities.json',\n              content: planMarkdown,\n            });\n\n            return { success: true, planMarkdown };\n          },\n        }),\n\n        finalizePlan: tool({\n          description: 'Mark planning phase complete',\n          inputSchema: z.object({}), // No parameters\n          execute: async () => {\n            await db.projects.update(projectId, {\n              phase: 'style',\n              updated_at: new Date().toISOString(),\n            });\n\n            return { success: true, nextPhase: 'style' };\n          },\n        }),\n      },\n    });\n\n    // Return streaming response\n    return result.toUIMessageStreamResponse();\n\n  } catch (error) {\n    console.error('[Chat API Error]', error);\n    return new Response('Internal Server Error', { status: 500 });\n  }\n}\n```\n\n### What's Happening Here?\n\n**1. Model Messages Conversion**\n```typescript\nconst modelMessages = await convertToModelMessages(messages);\n```\n\nClient sends messages in UI format (with parts arrays). This converts them to model-specific format. **Critical:** It's async! Forgetting `await` caused 20 minutes of debugging.\n\n**2. System Prompt with Context**\n```typescript\nsystem: `You are a proactive Game Design Agent...\n         Current Qualities: ${JSON.stringify(qualities, null, 2)}`,\n```\n\nEvery request includes current project state. The AI always knows what's been set so far.\n\n**3. Tool Schemas with Zod**\n```typescript\ninputSchema: z.object({\n  qualityKey: z.enum(['art_style', 'base_resolution', ...]),\n  value: z.string().min(1),\n}),\n```\n\nType-safe parameters. The SDK validates inputs before execution. Invalid data = error, not silent failure.\n\n**4. Server-Side Execution**\n```typescript\nexecute: async ({ qualityKey, value }) => {\n  await db.projects.update(projectId, { ... });\n  return { success: true, ... };\n},\n```\n\nTools execute on the server. Full database access. No client-side security concerns.\n\n**5. stopWhen: stepCountIs(10)**\n\nPrevents infinite loops. If the AI calls tools 10 times in one turn, stop. This saved me from a runaway generation bill later.\n\n### First Test (curl)\n\n```bash\ncurl -X POST http://localhost:3000/api/chat \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"messages\": [{\"role\": \"user\", \"content\": \"Set art style to pixel art\"}],\n    \"qualities\": {},\n    \"projectId\": \"test-123\"\n  }'\n```\n\n**Response:**\n\n```\ndata: {\"type\":\"text\",\"content\":\"I'll \"}\ndata: {\"type\":\"text\",\"content\":\"update \"}\ndata: {\"type\":\"text\",\"content\":\"the art style\"}\ndata: {\"type\":\"tool-call\",\"toolName\":\"updateQuality\",\"args\":{\"qualityKey\":\"art_style\",\"value\":\"Pixel Art\"}}\ndata: {\"type\":\"tool-result\",\"toolName\":\"updateQuality\",\"result\":{\"success\":true}}\ndata: {\"type\":\"text\",\"content\":\" to Pixel Art.\"}\n```\n\n**IT WORKED.**\n\nTool execution visible in the stream. Database updated. Success returned.\n\n**Time spent:** 62 minutes (over budget by 17 min, but working ‚úÖ)\n\n## Phase 4: Client Hooks (4:11 PM - 5:02 PM)\n\n### Replace useCopilotChat with useChat\n\n```typescript\n// components/planning/ChatInterface.tsx\n'use client';\n\nimport { useChat } from '@ai-sdk/react';\n\nexport function ChatInterface({ projectId, qualities }: Props) {\n  const {\n    messages,\n    input,\n    handleInputChange,\n    handleSubmit,\n    isLoading,\n  } = useChat({\n    api: '/api/chat',\n    body: { // Send additional context\n      projectId,\n      qualities,\n    },\n    onToolCall: async ({ toolCall }) => {\n      // Handle tool execution on client\n      console.log('üîß Tool called:', toolCall);\n\n      if (toolCall.toolName === 'updateQuality') {\n        const { qualityKey, value } = toolCall.input;\n        // Update local state to reflect change immediately\n        onQualityUpdate?.(qualityKey, value);\n      }\n\n      if (toolCall.toolName === 'updatePlan') {\n        const { planMarkdown } = toolCall.input;\n        onPlanUpdate?.(planMarkdown);\n      }\n\n      if (toolCall.toolName === 'finalizePlan') {\n        // Navigate to next phase\n        router.push(`/project/${projectId}/style`);\n      }\n    },\n  });\n\n  return (\n    <div className=\"chat-container\">\n      <div className=\"messages\">\n        {messages.map(msg => (\n          <Message key={msg.id} message={msg} />\n        ))}\n      </div>\n\n      <form onSubmit={handleSubmit}>\n        <input\n          value={input}\n          onChange={handleInputChange}\n          placeholder=\"Describe your game...\"\n        />\n        <button type=\"submit\" disabled={isLoading}>\n          {isLoading ? 'Thinking...' : 'Send'}\n        </button>\n      </form>\n    </div>\n  );\n}\n```\n\n### Rendering Messages with Parts\n\nAI SDK v6 messages have a `parts` array:\n\n```typescript\nfunction Message({ message }) {\n  // Extract text from all parts\n  const text = message.parts\n    ?.map(part => {\n      if (part.type === 'text') return part.text;\n      if (part.type === 'reasoning') return `[Thinking: ${part.text}]`;\n      return '';\n    })\n    .join('') || '';\n\n  return (\n    <div className={`message ${message.role}`}>\n      {text}\n    </div>\n  );\n}\n```\n\n**Why parts?** Future-proofing. v6 supports images, files, tool calls, reasoning‚Äîall as different part types.\n\n**Time spent:** 51 minutes (over budget by 6 min, but working ‚úÖ)\n\n## Phase 5: Testing (5:02 PM - 5:31 PM)\n\n### Test 1: Simple Message\n\n```\nMe: \"Hello\"\n\nAI: \"Hi! I'm here to help you plan game assets. What kind of\n     game are you building?\"\n```\n\n‚úÖ **Chat works.**\n\n### Test 2: Tool Execution\n\n```\nMe: \"Let's make a pixel art platformer\"\n\nAI: [Thinking...]\n    \"Great! I'll set up your project with:\n     - Art Style: Pixel Art\n     - Genre: Platformer\n\n     What perspective would you like? Side-view is common for\n     platformers.\"\n\n[Check console]\nüîß Tool called: {toolName: \"updateQuality\", input: {qualityKey: \"art_style\", value: \"Pixel Art\"}}\nüîß Tool called: {toolName: \"updateQuality\", input: {qualityKey: \"game_genre\", value: \"Platformer\"}}\n\n[Check database]\nSELECT art_style, game_genre FROM projects WHERE id = '...';\n-- art_style: \"Pixel Art\"\n-- game_genre: \"Platformer\"\n```\n\n‚úÖ **Tools execute and database updates.**\n\n### Test 3: Plan Building\n\n```\nMe: \"Show me a plan\"\n\nAI: [Thinking...]\n    \"Here's a starting asset plan for your pixel art platformer...\"\n\n    [Calls updatePlan tool with full markdown]\n\n[Right panel updates with formatted plan]\n```\n\n‚úÖ **Plan preview works.**\n\n### Test 4: Finalization\n\n```\nMe: \"This looks perfect, let's use it\"\n\nAI: \"Excellent! I'll finalize your plan.\"\n    [Calls finalizePlan tool]\n    \"Your plan is saved. Moving to style anchoring...\"\n\n[Navigation triggers to /project/[id]/style]\n```\n\n‚úÖ **Phase transition works.**\n\n### The Moment\n\n5:28 PM. All tests pass. Tools execute reliably. Database updates correctly. UI reflects changes.\n\n**Asset Hatch has a working AI planning agent.**\n\nAfter 4 hours of CopilotKit debugging hell, 3 hours of migration, and 1 crisis of confidence‚Äî**it finally works.**\n\nI took a screenshot. Committed the code. Went outside for 10 minutes.\n\n**Time spent:** 29 minutes (under budget ‚úÖ)\n\n## What I Learned (The Hard Way)\n\n### 1. AI SDK v6 is Different\n\nDon't copy v4 examples. `inputSchema` not `parameters`. `await convertToModelMessages()` is critical.\n\n### 2. System Prompts Matter\n\nThe AI is only as agentic as you make it. Compare:\n\n**Weak:**\n```typescript\nsystem: \"You are a helpful assistant.\"\n```\n\n**Strong:**\n```typescript\nsystem: `You are a PROACTIVE Game Design Agent.\n\nDO NOT wait for permission. When the user implies a preference,\nSET IT IMMEDIATELY using tools.\n\nExample:\nUser: \"I want pixel art\"\nYou: [Call updateQuality IMMEDIATELY] then respond\nNOT: \"Great choice! Would you like me to set that?\"\n`\n```\n\nThe second version produced 10x better results.\n\n### 3. stopWhen is Essential\n\n```typescript\nstopWhen: stepCountIs(10)\n```\n\nWithout this, I had cases where the AI got stuck in a loop:\n```\nCall updateQuality ‚Üí Call updateQuality ‚Üí Call updateQuality...\n```\n\n10 steps is generous but prevents runaway costs.\n\n### 4. Server-Side Tools are Better\n\nWith CopilotKit, tools were client-side React hooks. With Vercel AI SDK, they're server-side functions.\n\n**Benefits:**\n- Full database access (no API roundtrip needed)\n- Security (client can't bypass validation)\n- Simpler state management (single source of truth)\n\n### 5. Type Safety Catches Bugs Early\n\nZod schemas caught multiple bugs before they hit production:\n\n```typescript\nqualityKey: z.enum(['art_style', 'base_resolution', ...])\n```\n\nIf the AI calls `updateQuality({qualityKey: 'invalid', ...})`, it fails immediately with a clear error.\n\n### 6. Migration Took Exactly as Long as Estimated\n\n**Estimate:** 3h 15min\n**Actual:** 3h 16min\n\nWhy? Because I broke it into phases and tracked time actively. When Phase 3 went over by 17 minutes, I compressed Phase 4.\n\n## The Commits\n\n```bash\ncommit 5c5c305\nDate: Dec 26, 2025 - 3:12 PM\nMessage: feat: Set up initial Next.js application with CopilotKit\n         integration (before migration)\n\ncommit 6fbfd99\nDate: Dec 26, 2025 - 5:31 PM\nMessage: feat: Complete AI SDK v6 migration with working tool execution\n\nFiles changed: 11\nInsertions: 182\nDeletions: 104\n```\n\n## [ADR-005](https://github.com/zenchantlive/Asset-Hatch/blob/main/src/memory/adr/005-replace-copilotkit-with-vercel-ai-sdk.md): Replace CopilotKit with Vercel AI SDK\n\n**Status:** Accepted\n**Date:** 2025-12-26\n**Supersedes:** ADR-001\n\n**Decision:** Replace CopilotKit v1.50.1 with Vercel AI SDK v6 due to blocking bug in tool execution.\n\n**Rationale:**\n- CopilotKit `appendMessage` bug with no ETA for fix\n- Vercel AI SDK has 200x larger user base\n- Better type safety with Zod\n- More control over tool execution flow\n- Future-proof (Vercel team maintains it actively)\n\n**Trade-offs:**\n- 3 hours of migration work\n- More boilerplate code\n- Had to learn new API patterns\n\n**Result:** ‚úÖ Complete success. Tool execution works reliably.\n\n---\n\n## Reflections\n\nThis crisis forced me to learn AI SDK architecture at a depth I never would have otherwise.\n\nI now understand:\n- How streaming responses actually work\n- Why message conversion is necessary\n- How tool calling flows from client ‚Üí server ‚Üí model ‚Üí back\n- The difference between UI messages and model messages\n- Why type safety in tool schemas matters\n\n**The best learning comes from fixing broken things.**\n\nIf CopilotKit had worked, I'd have treated it as magic. Because it broke, I had to understand the actual mechanics.\n\nSometimes the frameworks that fail you teach you the most.\n\n---\n\n## Coming Next\n\nIn [Part 5: The Architecture](05-the-architecture-hybrid-persistence.md), we hit another wall.\n\nTurns out, you can't use Dexie (IndexedDB) in Next.js API routes. API routes run in Node.js. IndexedDB is browser-only.\n\nWhen the `/api/generate` route tried to read style anchors from the database, it crashed hard.\n\nThe solution? **Hybrid persistence** ‚Äî Prisma/SQLite for server, Dexie for client, sync between them.\n\nBut figuring that out took another debugging marathon and an IndexedDB polyfill hack that I'm both proud of and ashamed of.\n\n---\n\n**Commit References:**\n- `5c5c305` - Initial Next.js with CopilotKit (pre-migration)\n- `6fbfd99` - Complete AI SDK v6 migration with working tools\n\n**Files Created:**\n- `/app/api/chat/route.ts` - New Vercel AI SDK route\n- `/memory/AI_SDK_V6_GUIDE.md` - Internal reference docs\n- `/memory/adr/005-replace-copilotkit-with-vercel-ai-sdk.md` - Decision record\n\n**Tools Used:**\n- Vercel AI SDK v6.0.3\n- @openrouter/ai-sdk-provider v1.5.4\n- Zod v4.2.1\n\n**Time Investment:**\n- Research: 37 min\n- Dependencies: 17 min\n- API Route: 62 min\n- Client Hooks: 51 min\n- Testing: 29 min\n- **Total:** 3h 16min\n\n---\n\n**Previous:** [‚Üê Part 3: The Crisis](03-the-crisis-when-frameworks-fail.md)\n**Next:** [Part 5: The Architecture ‚Üí](05-the-architecture-hybrid-persistence.md)\n",
  "brief": "Previously: CopilotKit v1.50.1 is broken. Tool execution doesn't work. Spent 4 hours debugging. Made the decision to migrate to Vercel AI SDK.\nNow: 2:15 PM. Coffee refilled. Let's rip this out and rebuild it properly.\nThe Migration Checklist\nBefore d...",
  "author": "695abff5e4c04d1036cd307d",
  "sB": false,
  "isRepublished": false,
  "readTime": 11,
  "draft": "695acc12ea8913b271abd119",
  "tags": [
    "66ae032aa3a2a113838705d8",
    "67200dcf65618dd1726b670c",
    "56744723958ef13879b9534f",
    "679d6344a2de8e72a1d89e74",
    "67bff6a364ca958ae5a14013",
    "5fac0d7e8f0a0265534779f5"
  ],
  "publication": "695ac03d428b39bd40085e89",
  "series": "695ac45c21b769e7641e57a5",
  "isNewsletterActivated": true,
  "coAuthors": [],
  "dateUpdated": "2026-01-04T21:28:11.223Z",
  "hasCustomDate": false,
  "metaDescription": "Step-by-step migration to Vercel AI SDK v6. Zod schemas, tool calling, streaming‚Äîeverything you need to know about making the switch.",
  "metaTitle": "Migrating from CopilotKit to Vercel AI SDK in 3 Hours | Part 4",
  "pollOptions": [],
  "badges": [],
  "questionReplies": [],
  "contributors": [],
  "uniqueReactions": [],
  "reactionToCountMapUnique": {
    "any": 1
  },
  "id": "695acc48f94021e4b87c76be"
}