# Slice 14: Export Project as ZIP with Manifest

## User Story
**As a user, I can click "Export" and download a ZIP file containing all my assets and a manifest.json file.**

## What This Slice Delivers
- Export page with options
- manifest.json generation
- ZIP packaging with JSZip
- Organized folder structure
- Browser download trigger

## Acceptance Criteria
- [ ] "Continue to Export" button on generation page (when all approved)
- [ ] Export page shows project summary
- [ ] Click "Export" â†’ ZIP downloads
- [ ] ZIP contains: assets/ folder, manifest.json, README.md
- [ ] Assets organized by category (assets/characters/, etc.)
- [ ] manifest.json has complete metadata
- [ ] Can open ZIP and use assets immediately

## Files Created/Modified
```
app/
â””â”€â”€ project/[id]/
    â”œâ”€â”€ generation/page.tsx          # MODIFY: Add export button
    â””â”€â”€ export/page.tsx              # NEW: Export page

lib/
â”œâ”€â”€ manifest-builder.ts              # NEW: Generate manifest.json
â””â”€â”€ export-packer.ts                 # NEW: Create ZIP package
```

## Prompt for AI Agent

```
Add export functionality with ZIP packaging.

MANIFEST BUILDER (lib/manifest-builder.ts):
Generate manifest.json structure:

```typescript
interface Manifest {
  project: {
    name: string;
    game_type: string;
    art_style: string;
    base_resolution: string;
    theme: string;
    mood: string;
    exported_at: string;
  };
  style: {
    description: string;
    color_palette: string[];
  };
  assets: {
    characters: AssetManifestEntry[];
    environment: AssetManifestEntry[];
    props: AssetManifestEntry[];
    ui: AssetManifestEntry[];
    icons: AssetManifestEntry[];
  };
  total_assets: number;
}

interface AssetManifestEntry {
  id: string;
  name: string;
  file: string;  // relative path: "assets/characters/knight.png"
  description: string;
  seed: number;
}

export async function buildManifest(
  project: Project,
  qualities: Qualities,
  styleAnchor: StyleAnchor,
  assets: Asset[],
  entities: Entity[]
): Promise<Manifest> {
  const manifest: Manifest = {
    project: {
      name: project.name,
      game_type: qualities.game_type || 'Unknown',
      art_style: qualities.art_style || 'Unknown',
      base_resolution: qualities.base_resolution || '32x32',
      theme: qualities.theme || 'Unknown',
      mood: qualities.mood || 'Unknown',
      exported_at: new Date().toISOString()
    },
    style: {
      description: styleAnchor.style_description || '',
      color_palette: styleAnchor.color_palette || []
    },
    assets: {
      characters: [],
      environment: [],
      props: [],
      ui: [],
      icons: []
    },
    total_assets: assets.length
  };
  
  // Group assets by category
  for (const asset of assets) {
    const entity = entities.find(e => e.id === asset.entity_id);
    const entry: AssetManifestEntry = {
      id: asset.id,
      name: asset.name,
      file: `assets/${asset.category}/${slugify(asset.name)}.png`,
      description: entity?.description || '',
      seed: asset.seed
    };
    manifest.assets[asset.category].push(entry);
  }
  
  return manifest;
}
```

EXPORT PACKER (lib/export-packer.ts):
Create ZIP with JSZip:

```typescript
import JSZip from 'jszip';

export async function createExportZip(
  manifest: Manifest,
  assets: Asset[],
  projectName: string
): Promise<Blob> {
  const zip = new JSZip();
  
  // Create folder structure
  zip.folder('assets/characters');
  zip.folder('assets/environment');
  zip.folder('assets/props');
  zip.folder('assets/ui');
  zip.folder('assets/icons');
  
  // Add assets to folders
  for (const asset of assets) {
    const filename = `assets/${asset.category}/${slugify(asset.name)}.png`;
    zip.file(filename, asset.image_blob);
  }
  
  // Add manifest.json
  zip.file('manifest.json', JSON.stringify(manifest, null, 2));
  
  // Add README.md
  const readme = generateReadme(manifest, projectName);
  zip.file('README.md', readme);
  
  // Generate ZIP
  return await zip.generateAsync({ type: 'blob' });
}

function generateReadme(manifest: Manifest, projectName: string): string {
  return `# ${projectName}

Generated by Asset Hatch

## Project Info
- Game Type: ${manifest.project.game_type}
- Art Style: ${manifest.project.art_style}
- Resolution: ${manifest.project.base_resolution}
- Total Assets: ${manifest.total_assets}

## Folder Structure
- assets/characters/ - Character sprites
- assets/environment/ - Tilesets and backgrounds
- assets/props/ - Interactive objects
- assets/ui/ - UI elements
- assets/icons/ - Item and status icons

## Using manifest.json
The manifest.json file contains metadata for all assets.
You can parse it in your game engine to load assets programmatically.

Example (JavaScript):
\`\`\`javascript
const manifest = require('./manifest.json');
manifest.assets.characters.forEach(char => {
  loadSprite(char.file, char.name);
});
\`\`\`
`;
}

function slugify(text: string): string {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-');
}
```

EXPORT PAGE (app/project/[id]/export/page.tsx):
Create export interface:

Display:
- Project name
- Asset summary (count by category)
- Color palette preview
- "Export Project" button (primary)

On Export:
1. Show loading state: "Preparing export..."
2. Build manifest with buildManifest()
3. Create ZIP with createExportZip()
4. Trigger download:
```typescript
const url = URL.createObjectURL(zipBlob);
const a = document.createElement('a');
a.href = url;
a.download = `${slugify(project.name)}-assets.zip`;
a.click();
URL.revokeObjectURL(url);
```
5. Show success message: "Download started!"
6. Update project phase to "export" (optional)

GENERATION PAGE UPDATE:
Add "Continue to Export" button:
- Show when all assets are generated (or at least some approved)
- Navigates to /project/[id]/export

VERIFY:
1. Generate all assets (or some)
2. Click "Continue to Export"
3. See export page with summary
4. Click "Export Project"
5. See loading indicator
6. ZIP downloads automatically
7. Extract ZIP
8. Verify folder structure:
   - assets/characters/ has character images
   - assets/environment/ has environment images
   - manifest.json exists and is valid JSON
   - README.md exists
9. Open manifest.json - all assets listed with correct paths
```

## GATE CHECK: End-to-End Workflow Complete

After this slice, validate the full workflow:

1. [ ] Create project from dashboard
2. [ ] Plan assets with agent
3. [ ] Approve plan
4. [ ] Upload style reference
5. [ ] Confirm style
6. [ ] Generate all assets
7. [ ] Export as ZIP
8. [ ] ZIP contains all assets with correct structure
9. [ ] manifest.json is valid and complete

**If all pass: Core MVP is complete! ðŸŽ‰**

## How to Verify

1. Go to export page
2. See project summary
3. Click "Export Project"
4. ZIP downloads
5. Extract ZIP
6. Find: assets/ folder, manifest.json, README.md
7. Assets organized correctly
8. manifest.json parseable

## What NOT to Build Yet
- No include/exclude options (later)
- No multiple export formats (later)
- No cloud upload (later)

## Notes

---

## Completion
- [ ] Slice complete
- [ ] Committed to git
- [ ] **GATE VALIDATED: Full workflow works end-to-end**
- Date: ___
